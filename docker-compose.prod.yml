# Production Docker Compose configuration
# Run: docker compose -f docker-compose.prod.yml up -d

services:
  web:
    image: elohite/chronicle:0.1.15
    # To build locally instead of pulling from DockerHub, comment above and uncomment:
    # build:
    #   context: .
    #   dockerfile: docker/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost}
      - DATABASE_URL=${DATABASE_URL:-}
      - SSO_ENABLED=${SSO_ENABLED:-False}
      - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID:-}
      - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET:-}
      - MICROSOFT_TENANT_ID=${MICROSOFT_TENANT_ID:-common}
      - EMAIL_HOST=${EMAIL_HOST:-}
      - EMAIL_PORT=${EMAIL_PORT:-587}
      - EMAIL_HOST_USER=${EMAIL_HOST_USER:-}
      - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD:-}
      - DEFAULT_FROM_EMAIL=${DEFAULT_FROM_EMAIL:-it@fynbus.dk}
      - CHRONICLE_EMAIL_RECIPIENTS=${CHRONICLE_EMAIL_RECIPIENTS:-}
      - CSRF_TRUSTED_ORIGINS=${CSRF_TRUSTED_ORIGINS:-}
      - SQLITE_DIR=/app/data  # For SQLite persistence in Docker
    volumes:
      - static_files:/app/staticfiles
      - media_files:/app/media
      - sqlite_data:/app/data  # For SQLite persistence
    # depends_on:
    #   - db  # Uncomment if using PostgreSQL
    restart: unless-stopped

  db:
    image: postgres:16-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-fynbus_chronicle}
      - POSTGRES_USER=${POSTGRES_USER:-chronicle}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-chronicle} -d ${POSTGRES_DB:-fynbus_chronicle}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ServiceDesk sync scheduler
  sync:
    image: elohite/chronicle:0.1.15
    # To build locally instead of pulling from DockerHub, comment above and uncomment:
    # build:
    #   context: .
    #   dockerfile: docker/Dockerfile.sync
    environment:
      - DEBUG=False
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE_URL=${DATABASE_URL:-}
      - SQLITE_DIR=/app/data
      - SERVICEDESK_URL=${SERVICEDESK_URL:-https://servicedesk.fynbus.dk}
      - SERVICEDESK_API_KEY=${SERVICEDESK_API_KEY}
      - SERVICEDESK_SYNC_ENABLED=${SERVICEDESK_SYNC_ENABLED:-True}
      - SERVICEDESK_SYNC_INTERVAL=${SERVICEDESK_SYNC_INTERVAL:-300}
    volumes:
      - sqlite_data:/app/data  # Share SQLite with web service
    depends_on:
      - web
    restart: unless-stopped

  # Optional: Nginx reverse proxy
  # nginx:
  #   image: nginx:alpine
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - static_files:/var/www/static:ro
  #     - media_files:/var/www/media:ro
  #     - ./certs:/etc/nginx/certs:ro
  #   depends_on:
  #     - web
  #   restart: unless-stopped

volumes:
  postgres_data:
  static_files:
  media_files:
  sqlite_data:
