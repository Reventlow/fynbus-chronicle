{% load markdown_extras %}
<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: #2C2825;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      color: #4A4540;
      font-size: 24px;
      border-bottom: 2px solid #E5E0D8;
      padding-bottom: 10px;
    }
    h2 {
      color: #6B635B;
      font-size: 18px;
      margin-top: 25px;
    }
    .stats-box {
      background-color: #FAF9F7;
      border: 1px solid #E5E0D8;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    .stats-grid {
      display: flex;
      justify-content: space-between;
      text-align: center;
    }
    .stat-item {
      flex: 1;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #4A4540;
    }
    .stat-label {
      font-size: 12px;
      color: #6B635B;
    }
    .summary {
      background-color: #FAF9F7;
      border-left: 4px solid #8B7355;
      padding: 15px;
      margin: 15px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #E5E0D8;
    }
    th {
      background-color: #F0EDE8;
      color: #4A4540;
      font-weight: 600;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-high { background-color: #A65D57; color: white; }
    .badge-medium { background-color: #C4A35A; color: white; }
    .badge-low { background-color: #7D8471; color: white; }
    .badge-resolved { background-color: #7D8471; color: white; }
    .badge-unresolved { background-color: #A65D57; color: white; }
    .incident {
      background-color: #FAF9F7;
      border: 1px solid #E5E0D8;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }
    .incident-unresolved {
      border-left: 4px solid #A65D57;
    }
    .footer {
      margin-top: 30px;
      padding-top: 15px;
      border-top: 1px solid #E5E0D8;
      font-size: 12px;
      color: #6B635B;
    }
  </style>
</head>
<body>
  <h1>FynBus IT Ugelog - {{ weeklog.week_label }}</h1>

  <div class="stats-box">
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-value">{{ weeklog.helpdesk_new }}</div>
        <div class="stat-label">Nye sager</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{{ weeklog.helpdesk_closed }}</div>
        <div class="stat-label">Lukkede</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{{ weeklog.helpdesk_open }}</div>
        <div class="stat-label">Åbne</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{% if weeklog.helpdesk_delta > 0 %}+{% endif %}{{ weeklog.helpdesk_delta }}</div>
        <div class="stat-label">Netto</div>
      </div>
    </div>
  </div>

  {% if chart_image %}
  <div style="margin: 15px 0;">
    <h2>Helpdesk Trend</h2>
    <img src="{{ chart_image }}" style="width:100%; max-width:600px;" alt="Helpdesk trend chart">
  </div>
  {% endif %}

  {% if weeklog.summary %}
  <h2>Ugeoversigt</h2>
  <div class="summary">
    {{ weeklog.summary|linebreaksbr }}
  </div>
  {% endif %}

  {% if weeklog.meeting_skipped %}
  <h2>Referat af mandags møde</h2>
  <p><em>Mødet blev ikke afholdt denne uge.</em>{% if weeklog.meeting_skipped_reason %} {{ weeklog.meeting_skipped_reason }}{% endif %}</p>
  {% elif weeklog.meeting_attendees or weeklog.meeting_minutes %}
  <h2>Referat af mandags møde</h2>
  {% if weeklog.meeting_attendees %}
  <p><strong>Deltagere:</strong> {{ weeklog.meeting_attendees }}</p>
  {% endif %}
  {% if weeklog.meeting_minutes %}
  <div class="summary">
    {{ weeklog.meeting_minutes|render_markdown }}
  </div>
  {% endif %}
  {% endif %}

  {% if priority_items %}
  <h2>Prioriterede Opgaver ({{ priority_items.count }})</h2>
  <table>
    <tr>
      <th>Opgave</th>
      <th>Prioritet</th>
      <th>Status</th>
    </tr>
    {% for item in priority_items %}
    <tr>
      <td>{{ item.title }}</td>
      <td><span class="badge badge-{{ item.priority }}">{{ item.get_priority_display }}</span></td>
      <td>{{ item.get_status_display }}</td>
    </tr>
    {% endfor %}
  </table>
  {% endif %}

  {% if absences %}
  <h2>Bemanding ({{ absences.count }})</h2>
  <table>
    <tr>
      <th>Medarbejder</th>
      <th>Type</th>
      <th>Periode</th>
    </tr>
    {% for absence in absences %}
    <tr>
      <td>{{ absence.staff_name }}</td>
      <td>{{ absence.get_absence_type_display }}</td>
      <td>{{ absence.start_date|date:"d/m" }} - {{ absence.end_date|date:"d/m" }}</td>
    </tr>
    {% endfor %}
  </table>
  {% endif %}

  {% if incidents %}
  <h2>Hændelser ({{ incidents.count }})</h2>
  {% for incident in incidents %}
  <div class="incident {% if not incident.resolved %}incident-unresolved{% endif %}">
    <strong>{{ incident.title }}</strong>
    <span class="badge badge-{{ incident.severity }}">{{ incident.get_severity_display }}</span>
    <span class="badge {% if incident.resolved %}badge-resolved{% else %}badge-unresolved{% endif %}">
      {% if incident.resolved %}Løst{% else %}Uløst{% endif %}
    </span>
    <p style="margin: 10px 0 0 0; font-size: 14px;">{{ incident.description|truncatewords:30 }}</p>
  </div>
  {% endfor %}
  {% endif %}

  <div class="footer">
    <p>Denne email er automatisk genereret af FynBus IT Chronicle.</p>
  </div>
</body>
</html>
